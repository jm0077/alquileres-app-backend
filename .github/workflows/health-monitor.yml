name: ðŸ¥ Monitor de Salud API

on:
  # Verificar cada dÃ­a a las 8:00 AM UTC que la API estÃ© funcionando
  schedule:
    - cron: '0 8 * * *'
  
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ¥ Verificar salud de la API
      run: |
        echo "ðŸ¥ Verificando salud de la API de alquileres..."
        echo "ðŸ“… Fecha: $(date)"
        echo "ðŸŒ URL: ${{ secrets.ALQUILERES_API_URL }}"
        
        # Verificar endpoint principal
        echo "ðŸ“¡ Verificando endpoint principal..."
        MAIN_RESPONSE=$(curl -s -w "HTTP_STATUS:%{http_code}" \
          -H "User-Agent: GitHub-HealthCheck/1.0" \
          "${{ secrets.ALQUILERES_API_URL }}/")
        
        MAIN_BODY=$(echo "$MAIN_RESPONSE" | sed 's/HTTP_STATUS:.*//')
        MAIN_STATUS=$(echo "$MAIN_RESPONSE" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d: -f2)
        
        echo "ðŸ“Š Status principal: $MAIN_STATUS"
        echo "ðŸ“‹ Respuesta: $MAIN_BODY"
        
        # Verificar endpoint de salud de recurrencia
        echo "ðŸ”„ Verificando servicio de recurrencia..."
        HEALTH_RESPONSE=$(curl -s -w "HTTP_STATUS:%{http_code}" \
          -H "User-Agent: GitHub-HealthCheck/1.0" \
          "${{ secrets.ALQUILERES_API_URL }}/api/recurring/health")
        
        HEALTH_BODY=$(echo "$HEALTH_RESPONSE" | sed 's/HTTP_STATUS:.*//')
        HEALTH_STATUS=$(echo "$HEALTH_RESPONSE" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d: -f2)
        
        echo "ðŸ“Š Status recurrencia: $HEALTH_STATUS"
        echo "ðŸ“‹ Respuesta health: $HEALTH_BODY"
        
        # Verificar endpoint de backup
        echo "ðŸ’¾ Verificando servicio de backup..."
        BACKUP_RESPONSE=$(curl -s -w "HTTP_STATUS:%{http_code}" \
          -H "User-Agent: GitHub-HealthCheck/1.0" \
          "${{ secrets.ALQUILERES_API_URL }}/api/backup/collections")
        
        BACKUP_STATUS=$(echo "$BACKUP_RESPONSE" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d: -f2)
        
        echo "ðŸ“Š Status backup: $BACKUP_STATUS"
        
        # Evaluar estado general
        ALL_HEALTHY=true
        
        if [[ "$MAIN_STATUS" != "200" ]]; then
          echo "âŒ Endpoint principal fallÃ³: $MAIN_STATUS"
          ALL_HEALTHY=false
        fi
        
        if [[ "$HEALTH_STATUS" != "200" ]]; then
          echo "âŒ Servicio de recurrencia fallÃ³: $HEALTH_STATUS"
          ALL_HEALTHY=false
        fi
        
        if [[ "$BACKUP_STATUS" != "200" ]]; then
          echo "âŒ Servicio de backup fallÃ³: $BACKUP_STATUS"
          ALL_HEALTHY=false
        fi
        
        # Generar reporte
        if [[ "$ALL_HEALTHY" == "true" ]]; then
          echo "âœ… Todos los servicios estÃ¡n funcionando correctamente"
          
          # Extraer informaciÃ³n de la respuesta de health
          SERVICE_NAME=$(echo "$HEALTH_BODY" | jq -r '.service // "N/A"')
          SERVICE_VERSION=$(echo "$HEALTH_BODY" | jq -r '.version // "N/A"')
          SERVICE_STRUCTURE=$(echo "$HEALTH_BODY" | jq -r '.structure // "N/A"')
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
        ## ðŸ¥ Monitor de Salud - Estado Saludable âœ…
        
        ### ðŸ“Š Estado de Servicios
        
        | Servicio | Estado | CÃ³digo |
        |----------|--------|---------|
        | ðŸ  API Principal | âœ… Activo | $MAIN_STATUS |
        | ðŸ”„ Recurrencia | âœ… Activo | $HEALTH_STATUS |
        | ðŸ’¾ Backup | âœ… Activo | $BACKUP_STATUS |
        
        ### â„¹ï¸ InformaciÃ³n del Sistema
        
        - **Servicio:** $SERVICE_NAME
        - **VersiÃ³n:** $SERVICE_VERSION  
        - **Estructura:** $SERVICE_STRUCTURE
        - **Ãšltima verificaciÃ³n:** $(date)
        
        ### ðŸŽ¯ Estado General: Operacional
        
        Todos los servicios estÃ¡n funcionando correctamente y listos para:
        - âœ… Generar egresos recurrentes
        - âœ… Realizar backups automÃ¡ticos
        - âœ… Procesar solicitudes de API
        
        EOF
          
        else
          echo "âš ï¸ Algunos servicios estÃ¡n fallando"
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
        ## ðŸ¥ Monitor de Salud - Problemas Detectados âš ï¸
        
        ### ðŸ“Š Estado de Servicios
        
        | Servicio | Estado | CÃ³digo |
        |----------|--------|---------|
        | ðŸ  API Principal | $([ "$MAIN_STATUS" == "200" ] && echo "âœ… Activo" || echo "âŒ Error") | $MAIN_STATUS |
        | ðŸ”„ Recurrencia | $([ "$HEALTH_STATUS" == "200" ] && echo "âœ… Activo" || echo "âŒ Error") | $HEALTH_STATUS |
        | ðŸ’¾ Backup | $([ "$BACKUP_STATUS" == "200" ] && echo "âœ… Activo" || echo "âŒ Error") | $BACKUP_STATUS |
        
        ### ðŸš¨ Acciones Requeridas
        
        1. Verificar logs de Render para identificar errores
        2. Revisar configuraciÃ³n de la API
        3. Confirmar que el servicio estÃ¡ desplegado correctamente
        4. Verificar conectividad con Firebase
        
        **Ãšltima verificaciÃ³n:** $(date)
        
        EOF
          
          exit 1
        fi

    - name: ðŸ“Š Verificar rendimiento bÃ¡sico
      if: success()
      run: |
        echo "ðŸ“Š Verificando rendimiento bÃ¡sico de la API..."
        
        # Medir tiempo de respuesta del endpoint de salud
        START_TIME=$(date +%s%N)
        
        curl -s "${{ secrets.ALQUILERES_API_URL }}/api/recurring/health" > /dev/null
        
        END_TIME=$(date +%s%N)
        RESPONSE_TIME=$((($END_TIME - $START_TIME) / 1000000))  # Convertir a milisegundos
        
        echo "â±ï¸ Tiempo de respuesta: ${RESPONSE_TIME}ms"
        
        # Evaluar rendimiento
        if [[ $RESPONSE_TIME -lt 1000 ]]; then
          PERFORMANCE_STATUS="ðŸŸ¢ Excelente"
        elif [[ $RESPONSE_TIME -lt 3000 ]]; then
          PERFORMANCE_STATUS="ðŸŸ¡ Aceptable"
        else
          PERFORMANCE_STATUS="ðŸ”´ Lento"
        fi
        
        echo "ðŸ“Š Rendimiento: $PERFORMANCE_STATUS"
        
        # Agregar al summary
        cat >> $GITHUB_STEP_SUMMARY << EOF
        
        ### â±ï¸ Rendimiento
        
        - **Tiempo de respuesta:** ${RESPONSE_TIME}ms
        - **EvaluaciÃ³n:** $PERFORMANCE_STATUS
        - **Umbral Ã³ptimo:** < 1000ms
        - **Umbral aceptable:** < 3000ms
        
        EOF

    - name: ðŸ”” NotificaciÃ³n final
      if: always()
      run: |
        if [[ "${{ job.status }}" == "success" ]]; then
          echo "âœ… VerificaciÃ³n de salud completada - Sistema operacional"
          echo "ðŸ“Š Todos los servicios estÃ¡n funcionando correctamente"
          echo "â±ï¸ Rendimiento dentro de parÃ¡metros aceptables"
        else
          echo "âš ï¸ VerificaciÃ³n de salud fallÃ³ - Se detectaron problemas"
          echo "ðŸ”§ Se requiere atenciÃ³n del administrador"
          echo "ðŸ“§ Revisar logs y estado del servicio en Render"
        fi
        
        echo "ðŸ“‹ PrÃ³xima verificaciÃ³n: MaÃ±ana a las 8:00 AM UTC"
        echo "ðŸ¥ Monitor de salud finalizado: $(date)"
