name: ğŸ”„ Generar Egresos Recurrentes

on:
  # Ejecutar automÃ¡ticamente el dÃ­a 1 de cada mes a las 2:00 AM UTC
  schedule:
    - cron: '0 2 1 * *'
  
  # Permitir ejecuciÃ³n manual desde GitHub
  workflow_dispatch:
    inputs:
      targetYear:
        description: 'AÃ±o destino (opcional)'
        required: false
        type: string
      targetMonth:
        description: 'Mes destino (opcional)'
        required: false
        type: string
      dryRun:
        description: 'Solo simular (no crear registros)'
        required: false
        type: boolean
        default: false

jobs:
  generate-recurring-expenses:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‹ InformaciÃ³n del workflow
      run: |
        echo "ğŸ”„ Generando egresos recurrentes de alquileres"
        echo "ğŸ“… Fecha: $(date)"
        echo "ğŸ¯ Target: Siguiente mes automÃ¡tico"
        
    - name: ğŸš€ Generar registros recurrentes
      run: |
        echo "ğŸ”„ Iniciando generaciÃ³n de egresos recurrentes..."
        
        # Preparar datos para la API
        if [[ -n "${{ github.event.inputs.targetYear }}" ]] && [[ -n "${{ github.event.inputs.targetMonth }}" ]]; then
          # Usar parÃ¡metros manuales
          PAYLOAD=$(cat <<EOF
        {
          "targetYear": ${{ github.event.inputs.targetYear }},
          "targetMonth": ${{ github.event.inputs.targetMonth }},
          "dryRun": ${{ github.event.inputs.dryRun || false }}
        }
        EOF
        )
          echo "ğŸ“Š Usando parÃ¡metros manuales: AÃ±o ${{ github.event.inputs.targetYear }}, Mes ${{ github.event.inputs.targetMonth }}"
        else
          # Usar automÃ¡tico (siguiente mes)
          PAYLOAD='{"dryRun": false}'
          echo "ğŸ“… Usando siguiente mes automÃ¡tico"
        fi
        
        echo "ğŸ“¤ Payload: $PAYLOAD"
        
        # Realizar llamada a la API (ARREGLADO: Content-Type correcto)
        RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-Alquileres/1.0" \
          -H "Accept: application/json" \
          --connect-timeout 30 \
          --max-time 120 \
          -d "$PAYLOAD" \
          "${{ secrets.ALQUILERES_API_URL }}/api/recurring/generate")
        
        # Separar respuesta y cÃ³digo HTTP
        HTTP_BODY=$(echo "$RESPONSE" | sed -n '1,/HTTP_STATUS:/p' | sed '$d')
        HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
        
        echo "ğŸ“Š HTTP Status: $HTTP_STATUS"
        echo "ğŸ“‹ Respuesta completa:"
        echo "$HTTP_BODY" | jq '.' 2>/dev/null || echo "$HTTP_BODY"
        
        # Verificar si fue exitoso
        if [[ "$HTTP_STATUS" == "200" ]]; then
          echo "âœ… GeneraciÃ³n completada exitosamente"
          
          # Extraer estadÃ­sticas de la respuesta JSON
          if echo "$HTTP_BODY" | jq '.' > /dev/null 2>&1; then
            TOTAL_CREATED=$(echo "$HTTP_BODY" | jq -r '.summary.totalCreated // 0')
            TOTAL_SKIPPED=$(echo "$HTTP_BODY" | jq -r '.summary.totalSkipped // 0') 
            TOTAL_ERRORS=$(echo "$HTTP_BODY" | jq -r '.summary.totalErrors // 0')
            PROPERTIES_PROCESSED=$(echo "$HTTP_BODY" | jq -r '.summary.propertiesProcessed // 0')
            DRY_RUN=$(echo "$HTTP_BODY" | jq -r '.summary.dryRun // false')
            
            echo "ğŸ“Š EstadÃ­sticas:"
            echo "   â€¢ Propiedades procesadas: $PROPERTIES_PROCESSED"
            echo "   â€¢ Egresos creados: $TOTAL_CREATED"
            echo "   â€¢ Egresos omitidos: $TOTAL_SKIPPED"
            echo "   â€¢ Errores: $TOTAL_ERRORS"
            echo "   â€¢ Modo simulaciÃ³n: $DRY_RUN"
            
            # Crear summary para GitHub
            cat >> $GITHUB_STEP_SUMMARY << EOF
        ## ğŸ”„ GeneraciÃ³n de Egresos Recurrentes Completada âœ…
        
        ### ğŸ“Š Resultado: Exitoso
        
        | MÃ©trica | Valor |
        |---------|--------|
        | ğŸ  Propiedades procesadas | $PROPERTIES_PROCESSED |
        | âœ… Egresos creados | $TOTAL_CREATED |
        | â­ï¸ Egresos omitidos | $TOTAL_SKIPPED |
        | âŒ Errores | $TOTAL_ERRORS |
        | ğŸ§ª Modo simulaciÃ³n | $DRY_RUN |
        
        ### ğŸ“… InformaciÃ³n del proceso
        - **Fecha de ejecuciÃ³n:** $(date)
        - **MÃ©todo:** $([ "$DRY_RUN" == "true" ] && echo "SimulaciÃ³n" || echo "GeneraciÃ³n real")
        - **API:** \`POST /api/recurring/generate\`
        
        EOF
            
            if [[ "$TOTAL_ERRORS" -gt 0 ]]; then
              echo "âš ï¸ Se encontraron $TOTAL_ERRORS errores durante la generaciÃ³n"
              echo "ğŸ“‹ Revisar respuesta completa arriba para mÃ¡s detalles"
            fi
            
            if [[ "$TOTAL_CREATED" -eq 0 ]] && [[ "$DRY_RUN" == "false" ]]; then
              echo "â„¹ï¸ No se crearon nuevos egresos - posibles causas:"
              echo "   â€¢ No hay egresos marcados como recurrentes (isRecurring: true)"
              echo "   â€¢ Los egresos ya fueron generados para este perÃ­odo"
              echo "   â€¢ No hay propiedades con egresos en el mes fuente"
            fi
            
          else
            echo "âš ï¸ La respuesta no es JSON vÃ¡lido, pero el status es 200"
          fi
          
        else
          echo "âŒ Error en la generaciÃ³n: HTTP $HTTP_STATUS"
          echo "ğŸ“‹ Respuesta del servidor:"
          echo "$HTTP_BODY"
          
          # Crear summary de error para GitHub
          cat >> $GITHUB_STEP_SUMMARY << EOF
        ## ğŸ”„ GeneraciÃ³n de Egresos Recurrentes FallÃ³ âŒ
        
        ### âŒ Error HTTP: $HTTP_STATUS
        
        **Respuesta del servidor:**
        \`\`\`
        $HTTP_BODY
        \`\`\`
        
        ### ğŸ”§ Posibles soluciones:
        
        1. **Si es HTTP 400:** Verificar formato del payload JSON
        2. **Si es HTTP 404:** Verificar que la ruta sea correcta
        3. **Si es HTTP 500:** Revisar logs del servidor en Render
        4. **Si es timeout:** La API puede estar ocupada o dormida
        
        **Fecha:** $(date)
        **URL:** ${{ secrets.ALQUILERES_API_URL }}/api/recurring/generate
        EOF
          
          exit 1
        fi

    - name: ğŸ“Š Obtener resumen post-generaciÃ³n
      if: success()
      run: |
        echo "ğŸ“Š Obteniendo resumen del estado actual..."
        
        # Obtener fecha actual para verificar
        CURRENT_YEAR=$(date +%Y)
        CURRENT_MONTH=$(date +%-m)
        
        # Llamar al endpoint de resumen
        SUMMARY_RESPONSE=$(curl -s \
          -H "User-Agent: GitHub-Actions-Alquileres/1.0" \
          -H "Accept: application/json" \
          --connect-timeout 30 \
          --max-time 60 \
          "${{ secrets.ALQUILERES_API_URL }}/api/recurring/summary?year=$CURRENT_YEAR&month=$CURRENT_MONTH")
        
        echo "ğŸ“‹ Resumen actual:"
        echo "$SUMMARY_RESPONSE" | jq '.' 2>/dev/null || echo "$SUMMARY_RESPONSE"
        
        # Extraer informaciÃ³n del resumen si es JSON vÃ¡lido
        if echo "$SUMMARY_RESPONSE" | jq '.' > /dev/null 2>&1; then
          TOTAL_PROPERTIES=$(echo "$SUMMARY_RESPONSE" | jq -r '.summary.properties // 0')
          TOTAL_EXPENSES=$(echo "$SUMMARY_RESPONSE" | jq -r '.summary.totalExpenses // 0')
          RECURRING_EXPENSES=$(echo "$SUMMARY_RESPONSE" | jq -r '.summary.totalRecurringExpenses // 0')
          
          echo "ğŸ“Š Estado del sistema:"
          echo "   â€¢ Total propiedades: $TOTAL_PROPERTIES"
          echo "   â€¢ Total egresos del mes: $TOTAL_EXPENSES" 
          echo "   â€¢ Egresos recurrentes: $RECURRING_EXPENSES"
          
          # Agregar al summary de GitHub
          cat >> $GITHUB_STEP_SUMMARY << EOF
        
        ### ğŸ“Š Estado Actual del Sistema
        
        | MÃ©trica | Valor |
        |---------|--------|
        | ğŸ  Total propiedades | $TOTAL_PROPERTIES |
        | ğŸ’° Egresos del mes actual | $TOTAL_EXPENSES |
        | ğŸ”„ Egresos recurrentes | $RECURRING_EXPENSES |
        
        > Consulta realizada para **$CURRENT_MONTH/$CURRENT_YEAR**
        EOF
        else
          echo "âš ï¸ No se pudo obtener resumen vÃ¡lido del sistema"
        fi

    - name: ğŸ”” NotificaciÃ³n de finalizaciÃ³n
      if: always()
      run: |
        if [[ "${{ job.status }}" == "success" ]]; then
          echo "ğŸ‰ Proceso completado exitosamente"
          echo "ğŸ“§ Los egresos recurrentes han sido procesados"
          echo "ğŸ” Revisar el summary arriba para detalles"
        else
          echo "âš ï¸ El proceso fallÃ³"
          echo "ğŸ”§ Revisar los logs arriba para identificar el problema"
          echo "ğŸ’¡ Intentar ejecuciÃ³n manual para debugging"
        fi
        
        echo "ğŸ“‹ Workflow finalizado: $(date)"
