name: ğŸ  Generar Egresos Recurrentes Alquileres

on:
  # Ejecutar automÃ¡ticamente el dÃ­a 1 de cada mes a las 2:00 AM UTC
  schedule:
    - cron: '0 2 1 * *'
  
  # Permitir ejecuciÃ³n manual desde GitHub
  workflow_dispatch:
    inputs:
      targetYear:
        description: 'AÃ±o destino (opcional)'
        required: false
        type: string
      targetMonth:
        description: 'Mes destino (opcional)'
        required: false
        type: string
      dryRun:
        description: 'Solo simular (no crear registros)'
        required: false
        type: boolean
        default: false

jobs:
  generate-recurring-expenses:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‹ InformaciÃ³n del workflow
      run: |
        echo "ğŸ  Generando egresos recurrentes de alquileres"
        echo "ğŸ“… Fecha: $(date)"
        echo "ğŸŒ Timezone: UTC"
        echo "ğŸ¯ Target: Siguiente mes automÃ¡tico"
        
    - name: ğŸš€ Generar registros recurrentes
      run: |
        echo "ğŸ”„ Iniciando generaciÃ³n de egresos recurrentes..."
        
        # Preparar datos para la API
        if [[ -n "${{ github.event.inputs.targetYear }}" ]] && [[ -n "${{ github.event.inputs.targetMonth }}" ]]; then
          PAYLOAD=$(cat <<EOF
        {
          "targetYear": ${{ github.event.inputs.targetYear }},
          "targetMonth": ${{ github.event.inputs.targetMonth }},
          "dryRun": ${{ github.event.inputs.dryRun || false }}
        }
        EOF
        )
          echo "ğŸ“Š Usando parÃ¡metros manuales: AÃ±o ${{ github.event.inputs.targetYear }}, Mes ${{ github.event.inputs.targetMonth }}"
        else
          PAYLOAD='{"dryRun": false}'
          echo "ğŸ“… Usando siguiente mes automÃ¡tico"
        fi
        
        echo "ğŸ“¤ Payload: $PAYLOAD"
        
        # Realizar llamada a la API
        RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-Alquileres/1.0" \
          -d "$PAYLOAD" \
          "${{ secrets.ALQUILERES_API_URL }}/api/recurring/generate")
        
        # Separar respuesta y cÃ³digo HTTP
        HTTP_BODY=$(echo "$RESPONSE" | sed -n '1,/HTTP_STATUS:/p' | sed '$d')
        HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
        
        echo "ğŸ“Š HTTP Status: $HTTP_STATUS"
        echo "ğŸ“‹ Respuesta completa:"
        echo "$HTTP_BODY" | jq '.' || echo "$HTTP_BODY"
        
        # Verificar si fue exitoso
        if [[ "$HTTP_STATUS" == "200" ]]; then
          echo "âœ… GeneraciÃ³n completada exitosamente"
          
          # Extraer estadÃ­sticas de la respuesta
          TOTAL_CREATED=$(echo "$HTTP_BODY" | jq -r '.summary.totalCreated // 0')
          TOTAL_SKIPPED=$(echo "$HTTP_BODY" | jq -r '.summary.totalSkipped // 0') 
          TOTAL_ERRORS=$(echo "$HTTP_BODY" | jq -r '.summary.totalErrors // 0')
          PROPERTIES_PROCESSED=$(echo "$HTTP_BODY" | jq -r '.summary.propertiesProcessed // 0')
          
          echo "ğŸ“Š EstadÃ­sticas:"
          echo "   â€¢ Propiedades procesadas: $PROPERTIES_PROCESSED"
          echo "   â€¢ Egresos creados: $TOTAL_CREATED"
          echo "   â€¢ Egresos omitidos: $TOTAL_SKIPPED"
          echo "   â€¢ Errores: $TOTAL_ERRORS"
          
          # Crear summary para GitHub
          cat >> $GITHUB_STEP_SUMMARY << EOF
        ## ğŸ  GeneraciÃ³n de Egresos Recurrentes Completada
        
        ### âœ… Resultado: Exitoso
        
        | MÃ©trica | Valor |
        |---------|--------|
        | ğŸ  Propiedades procesadas | $PROPERTIES_PROCESSED |
        | âœ… Egresos creados | $TOTAL_CREATED |
        | â­ï¸ Egresos omitidos | $TOTAL_SKIPPED |
        | âŒ Errores | $TOTAL_ERRORS |
        
        ### ğŸ“… InformaciÃ³n del proceso
        - **Fecha de ejecuciÃ³n:** $(date)
        - **MÃ©todo:** AutomÃ¡tico (GitHub Actions)
        - **API:** \`POST /api/recurring/generate\`
        
        EOF
          
          if [[ "$TOTAL_ERRORS" -gt 0 ]]; then
            echo "âš ï¸ Se encontraron errores durante la generaciÃ³n"
            echo "ğŸ“‹ Revisar logs para mÃ¡s detalles"
          fi
          
        else
          echo "âŒ Error en la generaciÃ³n: HTTP $HTTP_STATUS"
          echo "ğŸ“‹ Respuesta del servidor:"
          echo "$HTTP_BODY"
          
          # Crear summary de error para GitHub
          cat >> $GITHUB_STEP_SUMMARY << EOF
        ## ğŸ  GeneraciÃ³n de Egresos Recurrentes FallÃ³
        
        ### âŒ Error HTTP: $HTTP_STATUS
        
        **Respuesta del servidor:**
        \`\`\`json
        $HTTP_BODY
        \`\`\`
        
        **Fecha:** $(date)
        EOF
          
          exit 1
        fi

    - name: ğŸ“Š Obtener resumen post-generaciÃ³n
      if: success()
      run: |
        echo "ğŸ“Š Obteniendo resumen del estado actual..."
        
        # Obtener fecha actual para verificar
        CURRENT_YEAR=$(date +%Y)
        CURRENT_MONTH=$(date +%-m)
        
        # Llamar al endpoint de resumen
        SUMMARY_RESPONSE=$(curl -s \
          -H "User-Agent: GitHub-Actions-Alquileres/1.0" \
          "${{ secrets.ALQUILERES_API_URL }}/api/recurring/summary?year=$CURRENT_YEAR&month=$CURRENT_MONTH")
        
        echo "ğŸ“‹ Resumen actual:"
        echo "$SUMMARY_RESPONSE" | jq '.' || echo "$SUMMARY_RESPONSE"
        
        # Extraer informaciÃ³n del resumen
        TOTAL_PROPERTIES=$(echo "$SUMMARY_RESPONSE" | jq -r '.summary.properties // 0')
        TOTAL_EXPENSES=$(echo "$SUMMARY_RESPONSE" | jq -r '.summary.totalExpenses // 0')
        RECURRING_EXPENSES=$(echo "$SUMMARY_RESPONSE" | jq -r '.summary.totalRecurringExpenses // 0')
        
        echo "ğŸ“Š Estado del sistema:"
        echo "   â€¢ Total propiedades: $TOTAL_PROPERTIES"
        echo "   â€¢ Total egresos del mes: $TOTAL_EXPENSES" 
        echo "   â€¢ Egresos recurrentes: $RECURRING_EXPENSES"
        
        # Agregar al summary de GitHub
        cat >> $GITHUB_STEP_SUMMARY << EOF
        
        ### ğŸ“Š Estado Actual del Sistema
        
        | MÃ©trica | Valor |
        |---------|--------|
        | ğŸ  Total propiedades | $TOTAL_PROPERTIES |
        | ğŸ’° Egresos del mes actual | $TOTAL_EXPENSES |
        | ğŸ”„ Egresos recurrentes | $RECURRING_EXPENSES |
        
        > Consulta realizada para **$CURRENT_MONTH/$CURRENT_YEAR**
        EOF

    - name: ğŸ”” NotificaciÃ³n de finalizaciÃ³n
      if: always()
      run: |
        if [[ "${{ job.status }}" == "success" ]]; then
          echo "ğŸ‰ Proceso completado exitosamente"
          echo "ğŸ“§ Los egresos recurrentes han sido generados"
          echo "ğŸ” Revisar el dashboard de alquileres para confirmar"
        else
          echo "âš ï¸ El proceso fallÃ³"
          echo "ğŸ”§ Revisar los logs para identificar el problema"
          echo "ğŸ“ Contactar al administrador si es necesario"
        fi
        
        echo "ğŸ“‹ Workflow finalizado: $(date)"
